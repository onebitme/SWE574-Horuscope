{% extends 'base.html' %}
{% load instance_tags %}
{% block content %}
    <div class="container mt-3" style="max-width: 1024px;">
        <div class="card rounded shadow-lg">
            <div class="card-header text-white bg-secondary">
                <h4 class="mb-0">Post #{{ instance.id }} - {{ instance.datatype.community.name }}</h4>
            </div>
            <div class="card-body">
                    {% csrf_token %}
                    {% datatype_fields_from_instance_id view.kwargs.pk as fields_from_instance %}
                    {% for field in fields_from_instance %}
                        <div class="row" style="border-bottom: 1px solid #DDD;">
                            <div class="col-md-4" style="padding: 10px 15px;""><label><b>{{ field.name }}</b></label></div>
                            <div class="col-md-8" style="padding: 10px 15px;">
                                {% if field.name != 'Semantic Tags' %}
                                    {% if field.type == 9 %}
                                    <div class="form-group rounded mx-auto d-block card-img-top embed-responsive embed-responsive-16by9">
                                        {% autoescape off %}
                                            {% property_value instance.id field.id field.type %}
                                        {% endautoescape %}
                                    </div>
                                    {% elif field.type == 6 %}
                                        <div style="width: 100%;">
                                            <img style="max-width: 200px;max-height: 200px;width: auto;height: auto;" src="{% property_value instance.id field.id field.type %}" class="img-thumbnail" />
                                        </div>
                                    {% elif field.type == 4 %}
                                        <video class="rounded mx-auto d-block card-img-top"
                                               controls>
                                            <source src="{% property_value instance.id field.id field.type %}"
                                                    type="video/mp4">
                                        </video>
                                    {% elif field.type == 5 %}
                                        <audio class="rounded mx-auto d-block card-img-top"
                                               controls>
                                            <source src="{% property_value instance.id field.id field.type %}"
                                                    type="audio/ogg">
                                        </audio>
                                    {% elif field.type == 10 %}
                                        <p style="white-space: pre-wrap"
                                           id="id_{{ field.name }}"
                                           {% if field.required %}required{% endif %}>{% property_value view.kwargs.pk field.id field.type %}</p>
                                    {%  else %}
                                        <div>
                                               {% property_value view.kwargs.pk field.id field.type %}
                                        </div>
                                    {% endif %}
                                {% else %}
                                    <input type="hidden" id="hdn_tags" name="hdn_tags">
                                    <select id="tags"
                                            name="{{ field.name }}"
                                            disabled
                                            class="js-data-example-ajax form-control form-control-lg rounded"
                                            multiple="multiple" {% if field.required %}required{% endif %}></select>
                                    <script>
                                        $(document).ready(function () {
                                            var vals = '{% property_value view.kwargs.pk field.id field.type %}'.split(',');
                                            vals.forEach(function (e) {
                                                if (!$ajax.find('option:contains(' + e + ')').length)
                                                    $ajax.append($('<option>').text(e));
                                            });
                                            $ajax.val(vals).trigger("change");
                                        });
                                        var $ajax = $("#tags");

                                        function formatRepo(repo) {
                                            if (repo.loading) return repo.text;
                                            var markup = "<option id=" + repo.id + ">" + repo.id + "-" + repo.description + "<option>";
                                            return markup;
                                        }

                                        function formatRepoSelection(repo) {
                                            return repo.id;
                                        }

                                        $ajax.select2({
                                            ajax: {
                                                url: "https://www.wikidata.org/w/api.php?action=wbsearchentities&language=en&format=json&callback=?&",
                                                dataType: 'json',
                                                delay: 250,
                                                results: function (data, page) {
                                                    return {
                                                        results: $.map(data.search, function (item) {
                                                            return {
                                                                id: item.id + "-" + item.label,
                                                                text: item.text
                                                            };
                                                        })
                                                    };
                                                },
                                                multiple: true,
                                                data: function (params) {
                                                    return {
                                                        search: params.term
                                                    };
                                                },
                                                success: function (item) {
                                                },
                                                processResults: function (data, page) {
                                                    return {
                                                        results: $.map(data.search, function (item) {
                                                            return {
                                                                id: item.id + "-" + item.label,
                                                                text: item.text,
                                                                description: item.description
                                                            };
                                                        })
                                                    };
                                                },
                                                cache: true
                                            },
                                            escapeMarkup: function (markup) {
                                                return markup;
                                            },
                                            minimumInputLength: 3,
                                            templateResult: formatRepo,
                                            templateSelection: formatRepoSelection
                                        });
                                    </script>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}